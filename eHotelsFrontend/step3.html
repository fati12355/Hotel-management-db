<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>R√©servation | √âtape 3</title>

    <!-- Lien vers ton fichier CSS personnalis√© -->
    <link rel="stylesheet" href="css/reservation.css">

    <!-- Optionnel : ic√¥ne du site -->
    <link rel="icon" href="img/logo.png" type="image/png">
</head>

<body>

    <h2>R√©server une chambre</h2>

    <label for="hotelChain">Choisir une cha√Æne d'h√¥tels :</label>
    <select id="hotelChain"></select>

    <label for="hotel">Choisir un h√¥tel :</label>
    <select id="hotel">
        <option>Veuillez choisir une cha√Æne d'h√¥tels</option>
    </select>

    <label for="appliances">S√©lectionner les √©quipements :</label>
    <select id="appliances">
        <option value="">Tous</option>
    </select>

    <label for="capacity">Capacit√© :</label>
    <select id="capacity">
        <option value="">Tous</option>
    </select>

    <label for="extras">Extras :</label>
    <select id="extras">
        <option value="">Tous</option>
    </select>

    <label for="existing_damage">Dommages existants :</label>
    <select id="existing_damage">
        <option value="">Tous</option>
    </select>

    <label for="room">Choisir une chambre :</label>
    <select id="room">
        <option>S√©lectionnez un h√¥tel et des filtres</option>
    </select>

    <button id="confirmReservation">Confirmer la r√©servation</button>
    <div id="reservationDetails" class="reservation-card" style="display:none;"></div>



    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            await chargerChainesHoteliers();

            document.getElementById("hotelChain").addEventListener("change", async (e) => {
                const hotelchain_id = e.target.value;
                if (!hotelchain_id) return;

                await chargerHotels(hotelchain_id);
                resetFiltres();
                resetRooms();
            });

            document.getElementById("hotel").addEventListener("change", async (e) => {
                const hotel_id = e.target.value;
                if (!hotel_id) return;

                resetFiltres();
                await chargerFiltresChambres();
                await chargerChambresDisponibles(hotel_id);
            });

            const filtres = ["appliances", "capacity", "extras", "existing_damage"];
            filtres.forEach(id => {
                document.getElementById(id).addEventListener("change", appliquerFiltres);
            });

            document.getElementById("confirmReservation").addEventListener("click", confirmerReservation);
        });

        async function chargerChainesHoteliers() {
            try {
                const response = await fetch("http://localhost:3000/hotelChains");
                const chains = await response.json();
                const select = document.getElementById("hotelChain");

                chains.forEach(chain => {
                    const option = document.createElement("option");
                    option.value = chain.hotelchain_id;
                    option.textContent = chain.hotel_chain_name;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error("Erreur chargement des cha√Ænes :", err);
            }
        }

        async function chargerHotels(hotelchain_id) {
            try {
                const response = await fetch(`http://localhost:3000/hotels?hotelchain_id=${hotelchain_id}`);
                const hotels = await response.json();
                const select = document.getElementById("hotel");
                select.innerHTML = "<option value=''>Choisir un h√¥tel</option>";

                hotels.forEach(hotel => {
                    let option = document.createElement("option");
                    option.value = hotel.hotel_id;
                    option.textContent = hotel.email_address;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error("Erreur chargement des h√¥tels :", err);
            }
        }

        async function chargerFiltresChambres() {
            try {
                const response = await fetch("http://localhost:3000/roomFilters");
                const filters = await response.json();

                remplirFiltre("appliances", filters.map(f => f.appliances));
                remplirFiltre("capacity", filters.map(f => f.capacity));
                remplirFiltre("extras", filters.map(f => f.extras));
                remplirFiltre("existing_damage", filters.map(f => f.existing_damage));
            } catch (err) {
                console.error("Erreur filtres chambres :", err);
            }
        }

        function remplirFiltre(id, valeurs) {
            const select = document.getElementById(id);
            select.innerHTML = "<option value=''>Tous</option>";
            [...new Set(valeurs)].filter(Boolean).forEach(val => {
                const opt = document.createElement("option");
                opt.value = val;
                opt.textContent = val;
                select.appendChild(opt);
            });
        }

        function resetFiltres() {
            ["appliances", "capacity", "extras", "existing_damage"].forEach(id => {
                document.getElementById(id).innerHTML = "<option value=''>Tous</option>";
            });
        }

        function resetRooms() {
            document.getElementById("room").innerHTML = "<option value=''>S√©lectionner une chambre</option>";
        }

        async function appliquerFiltres() {
            const hotel_id = document.getElementById("hotel").value;
            if (!hotel_id || hotel_id === "undefined") {
                console.warn("‚ö†Ô∏è hotel_id manquant, filtre ignor√©");
                return;
            }

            const appliances = document.getElementById("appliances").value;
            const capacity = document.getElementById("capacity").value;
            const extras = document.getElementById("extras").value;
            const existing_damage = document.getElementById("existing_damage").value;

            await chargerChambresDisponibles(hotel_id, appliances, capacity, extras, existing_damage);
        }


        async function chargerChambresDisponibles(hotel_id, appliances = "", capacity = "", extras = "", existing_damage = "") {
            try {
                const url = `http://localhost:3000/availableRooms?hotel_id=${hotel_id}&appliances=${encodeURIComponent(appliances)}&capacity=${capacity}&extras=${encodeURIComponent(extras)}&existing_damage=${encodeURIComponent(existing_damage)}`;
                const response = await fetch(url);
                const rooms = await response.json();

                const select = document.getElementById("room");
                select.innerHTML = "<option value=''>S√©lectionner une chambre</option>";

                if (!Array.isArray(rooms)) {
                    console.error("‚ö†Ô∏è Format invalide re√ßu pour les chambres :", rooms);
                    return;
                }

                rooms.forEach(room => {
                    const option = document.createElement("option");
                    option.value = room.room_id;
                    option.textContent = `Chambre ${room.room_id} - ${room.price}$`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error("‚ùå Erreur chargement chambres :", err);
            }
        }

        async function confirmerReservation() {
            const client_id = localStorage.getItem("client_id");
            const room_id = document.getElementById("room").value;
            const reservation_date = new Date().toISOString();

            if (!client_id || !room_id) {
                alert("‚ùå Informations manquantes !");
                return;
            }

            const reservationData = { client_id, room_id, reservation_date };

            try {
                const response = await fetch("http://localhost:3000/reservation", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(reservationData)
                });

                const result = await response.json();
                console.log(" R√©ponse re√ßue du backend :", result);

                if (response.ok) {
                    alert("‚úÖ R√©servation confirm√©e !");

                    // ‚ûï Attendre que l'utilisateur ferme la bo√Æte de dialogue
                    setTimeout(() => {
                        const nom = localStorage.getItem("client_name") || "Nom inconnu";
                        const tel = localStorage.getItem("client_tel") || "T√©l√©phone inconnu";
                        const chainName = document.getElementById("hotelChain").selectedOptions[0]?.textContent || "Non pr√©cis√©";
                        const hotel = document.getElementById("hotel").selectedOptions[0]?.textContent || "Non pr√©cis√©";
                        const arrival = localStorage.getItem("arrivalDate") || "Non sp√©cifi√©e";
                        const departure = localStorage.getItem("departureDate") || "Non sp√©cifi√©e";
                        const reservationDetails = document.getElementById("reservationDetails");

                        reservationDetails.innerHTML = `
                    <div class="card p-4 shadow" style="background:#f9f9f9;">
                        <h3 class="mb-3">üìã D√©tails de votre r√©servation :</h3>
                        <ul>
                            <li><strong>Nom :</strong> ${nom}</li>
                            <li><strong>T√©l√©phone :</strong> ${tel}</li>
                            <li><strong>Client ID :</strong> ${client_id}</li>
                            <li><strong>Cha√Æne h√¥teli√®re :</strong> ${chainName}</li>
                            <li><strong>H√¥tel :</strong> ${hotel}</li>
                            <li><strong>Chambre :</strong> ${room_id}</li>
                            <li><strong>R√©servation ID :</strong> ${result.reservation_id || "N/A"}</li>
                            <li><strong>Date d'arriv√©e :</strong> ${arrival}</li>
                            <li><strong>Date de d√©part :</strong> ${departure}</li>
                            <li><strong>Date de r√©servation :</strong> ${new Date(reservation_date).toLocaleString()}</li>
                        </ul>
                    </div>
                `;
                        reservationDetails.style.display = "block";

                        localStorage.clear();
                    }, 100);

                } else {
                    alert("‚ùå Erreur : " + (result.message || "R√©servation √©chou√©e."));
                }

            } catch (err) {
                console.error("‚ùå Erreur lors de la r√©servation :", err);
                alert("‚ùå Une erreur est survenue lors de la r√©servation.");
            }
        }

    </script>
</body>

</html>