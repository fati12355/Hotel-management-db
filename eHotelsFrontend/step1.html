<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>R√©servation | √âtape 1</title>

    <!-- Lien vers ton fichier CSS personnalis√© -->
    <link rel="stylesheet" href="css/reservation.css">

    <!-- Optionnel : ic√¥ne du site -->
    <link rel="icon" href="img/logo.png" type="image/png">
</head>

<body>

    <div class="container">
        <h2>√âtape 1 : Informations personnelles</h2>
        <p style="text-align: center; margin-bottom: 30px;">
            Veuillez Enregistrer votre Adresse compl√®te pour commencer la r√©servation.
        </p>
        <form id="addressForm">
            <input type="number" id="civic_number" placeholder="Num√©ro civique" required>
            <input type="text" id="postal_code" placeholder="Code postal" required>
            <input type="text" id="street_name" placeholder="Rue" required>
            <input type="text" id="town" placeholder="Ville" required>
            <input type="text" id="province" placeholder="Province" required>
            <input type="text" id="country" placeholder="Pays" required>
            <button type="submit">Continuer</button>
        </form>

        <script>
            document.getElementById("addressForm").addEventListener("submit", async (e) => {
                e.preventDefault(); // Emp√™cher le rechargement de la page

                // R√©cup√©rer les valeurs du formulaire
                const addressData = {
                    civic_number: document.getElementById("civic_number").value,
                    postal_code: document.getElementById("postal_code").value,
                    street_name: document.getElementById("street_name").value,
                    town: document.getElementById("town").value,
                    province: document.getElementById("province").value,
                    country: document.getElementById("country").value
                };
                const postalRegex = /^[A-Za-z]\d[A-Za-z]\d[A-Za-z]\d$/;
                if (!postalRegex.test(addressData.postal_code)) {
                    alert("‚ùå Le code postal doit √™tre au format A1A1A1.");
                    return;
                }
                console.log("üì§ Envoi des donn√©es :", addressData); // üîç Log avant envoi

                try {
                    // Envoyer les donn√©es au backend
                    const response = await fetch("http://localhost:3000/address", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(addressData)
                    });

                    console.log("‚úÖ R√©ponse re√ßue :", response); // üîç Log de la r√©ponse du serveur

                    const result = await response.json();

                    if (response.ok) {
                        // Enregistrer l'adresse dans localStorage pour l'utiliser plus tard
                        localStorage.setItem("address_id", result.address_id);
                        alert("‚úÖ Adresse enregistr√©e avec succ√®s !");

                        // Rediriger vers la deuxi√®me √©tape (enregistrement du client)
                        window.location.href = "step2.html";
                    } else {
                        console.error("‚ùå Erreur c√¥t√© serveur :", result.error);
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error("‚ùå Erreur lors de l'enregistrement de l'adresse:", error);
                    alert("‚ùå Impossible d'enregistrer l'adresse. Veuillez r√©essayer.");
                }
            });
        </script>
    </div>
</body>

</html>